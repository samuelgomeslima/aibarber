# Securing OpenAI Credentials

This project keeps all direct communication with OpenAI inside the Azure Functions app under the `api/` folder. The static front-end never embeds the real `OPENAI_API_KEY`.

## Azure Static Web Apps (Free Plan)

1. Deploy a Static Web App on the free SKU. Azure automatically provisions a Functions environment that shares the same domain as your front-end (`https://<app>.azurestaticapps.net`).
2. Open the resource in the Azure Portal and navigate to **Configuration** → **Application settings**.
3. Add the following settings:
   - `OPENAI_API_KEY` – your real OpenAI key. This value stays server-side.
   - `IMAGE_API_TOKEN` – a random string that works as a shared secret between the UI and the Functions. Rotate it regularly.
4. Save the configuration and restart the Functions app if Azure does not redeploy automatically.

## GitHub Actions Secrets

The workflow in `.github/workflows/` builds the Expo web bundle and deploys it to Azure. Store these secrets under **Repository → Settings → Secrets and variables → Actions**:

| Secret | Purpose |
| ------ | ------- |
| `AZURE_STATIC_WEB_APPS_API_TOKEN_*` | Token generated by Azure when you create the SWA resource. Required for deployments. |
| `EXPO_PUBLIC_ASSISTANT_API_TOKEN` | Optional. Injected into the build so the static bundle knows the shared token to send in the `x-api-key` header. |
| `EXPO_PUBLIC_SUPABASE_URL` / `EXPO_PUBLIC_SUPABASE_ANON_KEY` | Existing Supabase configuration. |

> Do **not** add `OPENAI_API_KEY` to GitHub. The Functions runtime reads it from Azure at execution time.

## Local Development

Add a `api/local.settings.json` file (excluded from git) with your keys:

```json
{
  "IsEncrypted": false,
  "Values": {
    "AzureWebJobsStorage": "UseDevelopmentStorage=true",
    "FUNCTIONS_WORKER_RUNTIME": "node",
    "OPENAI_API_KEY": "sk-your-key",
    "IMAGE_API_TOKEN": "dev-shared-secret"
  }
}
```

Expose the same shared token to the Expo dev server:

```bash
export EXPO_PUBLIC_ASSISTANT_API_TOKEN=dev-shared-secret
npm run web
```

Start the Functions emulator separately:

```bash
cd api
npm install
npm run start
```

With this setup, the front-end calls `http://localhost:7071/api/assistant/*` through the Static Web Apps CLI or your own proxy (see `docs/LOCAL_DEV.md`).
